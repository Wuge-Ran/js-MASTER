<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" href="css/yun.css">
    <script src="jquery-3.3.1.js"></script>
    <style>
        /*css reset*/
        body,h1,h2,h3,h4,p{
            margin: 0;
        }
        ul{
            margin: 0;
            padding: 0;
            list-style: none;
        }
        a{
            color: #000;
            text-decoration: none;
        }
        img{
            vertical-align: top;
        }
        /*tool*/
        .clearfix:after{
            content: "";
            display: block;
            clear:both;
        }
        .fl{
            float: left;
        }
        .fr{
            float: right;
        }
    </style>
</head>
<body>
    <div id="bullet">删除成功</div>
    <div id="mask"></div>
    <div id="box">
        <header class="title clearfix">
            <h1 class="fl">
                logo
            </h1>
            <div class="fr">
                <i class="user_head fl"></i>
                <i class="arrow_down fl"></i>
                <i class="setting fl"></i>
            </div>
        </header>
        <div class="tools clearfix">
            <div class="buttons fl">
                <div class="download">下载</div>
                <div class="share">分享</div>
                <div class="move">移动到</div>
                <div class="rename">重命名</div>
                <div class="dele">删除</div>
                <div class="newFile">新建文件夹</div>
                <div class="renew"></div>
            </div>
            <div class="changetype fr">
                切换显示
            </div>
        </div>
        <div id="content" class="clearfix">
            <div class="list">
                <!-- <h3 class="active">微云</h3>
                <ul>
                    <h3 class="active">JS课程</h3>
                    <ul>
                        <h3 class="no_chlid">123</h3>
                        <h3 class="has_chlid">333</h3>
                    </ul>
                </ul> -->
            </div>
            <div class="item">
                    <div id="del_window">
                        <i class="fr"></i>
                        <h3>确定要删除这个文件夹吗？</h3>
                        <p>已删除的文件可以在回收站找到</p>
                        <div class="ensure">确定</div>
                        <div class="cancel">取消</div>
                    </div>
                <nav class="clearfix">
                    <i class="fl"></i>
                    <div class="nav clearfix">
                        <!-- <div class="fl">微云</div>
                        <span class="fl"></span>
                        <div class="active fl">JS课程</div>
                        <span class="fl"></span>
                        <div class="fl">CSS课程</div> -->
                    </div>
                </nav>
                <div class="file clearfix">
                    <div class="checked"><i class="checked"></i><span>JS基础课程</span></div>
                    <div><i></i><span>JS基础课程</span></div>
                    <div><i></i><span>JS基础课程</span></div>
                    <div><i></i><span>JS基础课程</span></div>
                    <div><i></i><span>JS基础课程</span></div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        //自定义高度
        var content = document.querySelector('#content');
        var header = document.querySelector('.title');
        var tools = document.querySelector('.tools');
        var contHeight = (document.documentElement.clientHeight - header.offsetHeight - tools.offsetHeight) + 'px';
        content.style.height = contHeight;
        window.onresize = function (){
            var contHeight = (document.documentElement.clientHeight - header.offsetHeight - tools.offsetHeight) + 'px';
            content.style.height = contHeight;
        }
        var data = [{
            title:'微云',
            id:1001,
            pid:-1
        },{
            title:'JS课程',
            id:1002,
            pid:1001
        },{
            title:'123',
            id:1022,
            pid:1002
        },{
            title:'333',
            id:1202,
            pid:1002
        },{
            title:'333_1',
            id:2202,
            pid:1202
        },{
            title:'HTML课程',
            id:1003,
            pid:1001
        },{
            title:'css课程',
            id:2232,
            pid:1003
        },{
            title:'css课程-1',
            id:2233,
            pid:2232
        },{
            title:'css课程-2',
            id:2234,
            pid:2232
        },{
            title:'css课程-3',
            id:2235,
            pid:2232
        },{
            title:'css课程-4',
            id:2236,
            pid:2232
        },{
            title:'css课程-5',
            id:2237,
            pid:2232
        },{
            title:'css课程-6',
            id:2238,
            pid:2232
        }]
        //通过id找数据
        function getItemById(id){
            for(var i = 0;i < data.length;i++){
                if(data[i].id === id){
                    return data[i];
                }
            }
            return null;
        }
        //通过id找子集
        function getChildsById(id){
            var arr = new Array();
            for(var i = 0;i < data.length;i++){
                if(data[i].pid === id){
                    arr.push(data[i]);
                }   
            }
            return arr;
        }
        //通过id找所以子孙
        function getAllchildsById(id){
            var arr = new Array();
            var thisOne = getItemById(id);
            if(thisOne){
                arr.push(thisOne);
                var thisOneChilds = getChildsById(id);
                for(var i = 0;i < thisOneChilds.length;i++){
                    var cId = thisOneChilds[i].id;
                    arr = arr.concat(getAllchildsById(cId));
                }
            }
            return arr;
        }
        //通过id找父级
        function getParentsById(id){
            var arr = new Array();
            var item = getItemById(id);
            if(item){
                arr.push(item);
                arr = arr.concat(getParentsById(item.pid));
            }
            return arr;
        }
        var init = -1;
        //生成树形结构
        function createTreeHTML(id){
            var arr = getChildsById(id);
            var html = '';
            if(arr.length){
                html +='<ul>';
                for(var i = 0;i < arr.length;i++){
                    var cla = createTreeHTML(arr[i].id) ? 'active' : 'no_chlid';
                    html +='<li><h3 class="'+ cla +'" cus_id='+ arr[i].id +'>'+ arr[i].title +'</h3>';
                    html += createTreeHTML(arr[i].id);
                    html +='</li>';
                }
                html +='</ul>';
            }
            return html;
        }
        $('#content .list').html(createTreeHTML(init));
        $('#content .list h3[cus_id="1001"]').css('color','#55addc');
        //生成bar结构
        function createBarHTML(id){
            var arrP = getParentsById(id).reverse();
            var html = '';
            for(var i = 0;i < arrP.length;i++){
                var cla = i ===  arrP.length-1 ? 'active' : '';
                html += '<div class="fl '+ cla +'" cus_id="'+ arrP[i].id +'">'+ arrP[i].title +'</div>';
                if(i !==  arrP.length-1){
                    html +='<span class="fl"></span>';
                }
            }
            return html;
        }
        $('.item .nav').html(createBarHTML(1001));

        //生成文件结构
        function createFileHTML(id){
            var childs = getChildsById(id);
            var html = '';
            if(childs.length){
                $('.item .file').removeClass('no_file');
                for(var i = 0;i < childs.length;i++){
                    html += '<div cus_id="'+ childs[i].id +'"><i></i><span>'+ childs[i].title +'</span><input type="text"/></div>'
                   
                }
            }else{
                $('.item .file').addClass('no_file');
            }
            return html;
        }
        $('.item .file').html(createFileHTML(1001));
        //交互
        $('.list').on('click','h3',function (){
            $('.list h3').css('color','#949ea4');
            $(this).css('color','#55addc');
            var id = $(this).attr('cus_id');
            $('.item .nav').html(createBarHTML(+id));
            $('.item .file').html(createFileHTML(+id));
            $('nav i').removeClass('checked');
        });
        $('nav .nav').on('click','div',function (){
            var id = $(this).attr('cus_id');
            $('.item .nav').html(createBarHTML(+id));
            $('#content .list h3').css('color','#949ea4');
            $('#content .list h3[cus_id="'+ id +'"]').css('color','#55addc');
            $('.item .file').html(createFileHTML(+id));
            $('nav i').removeClass('checked');
        });
        $('.item .file').on('click','div',function (){
            var id = $(this).attr('cus_id');
            $('.item .nav').html(createBarHTML(+id));
            $('.item .file').html(createFileHTML(+id));
            $('#content .list h3').css('color','#949ea4');
            $('#content .list h3[cus_id="'+ id +'"]').css('color','#55addc');
            $('nav i').removeClass('checked');
        })
        //全选单选
        $('nav i').on('click',function (){
            $(this).toggleClass('checked');
            var bl = $(this).is('.checked') ? true : false;
            if(bl){
                $('.file div').addClass('checked');
                $('.file div').find('i').addClass('checked');
                $('.file').find('i').css('border','1px solid #55addc');
            }else{
                $('.file div').removeClass('checked');
                $('.file div').find('i').removeClass('checked');
                $('.file').find('i').css('border','1px solid transparent');
            }
        })
        $('.file').on('mouseover','div',function (){
            $(this).find('i').css('border','1px solid #55addc');
        });
        $('.file').on('mouseout','div',function (){
            if(!$(this).is('.checked')){
                $(this).find('i').css('border','1px solid transparent');
            }    
        });
        $('.file').on('click','i',function (e){
            $(this).toggleClass('checked');
            $(this).parent().toggleClass('checked');
            var n = 0;
            $('.file div').each(function (key,item){
                if($(item).is('.checked')){
                    n++;
                }else{
                    return;
                }
            })
            if(n === $('.file div').length){
                $('nav i').addClass('checked');
            }else{
                $('nav i').removeClass('checked');
            }
            e.stopPropagation();
        })
        //弹框方法
        var bullet = document.querySelector('#bullet');
        function showBul(){
            tweenMove({
                ele : bullet,
                attr : 'top',
                target : 0,
                duration : 600,
                callback:function (){
                    setTimeout(function (){
                        tweenMove({
                            ele : bullet,
                            attr : 'top',
                            target : -40,
                            duration : 600,
                        })
                    },600)
                }
            });
        }
        //点按删除
        $('.buttons .dele').on('click',function (){
            if($('.file>div').is('.checked')){
                $('#mask').css('display','block');
                $('#del_window').css('display','block');
            }else{
                $('#bullet').text('你什么都没选，删什么!?弱智吗？').css('background','#ef8989');
                showBul();
            }
            $('#del_window i').on('click',function (){
                $('#mask').css('display','none');
                $('#del_window').css('display','none');
            })
            $('#del_window .cancel').on('click',function (){
                $('#mask').css('display','none');
                $('#del_window').css('display','none');
            })
            $('#del_window .ensure').on('click',function (){
                var treeActiveId = +$('.nav >.active').attr('cus_id');
                var arr = [];
                $('.file>.checked').each(function (key,item){
                    arr.push(+$(item).attr('cus_id'));
                });
                var arr2 = [];
                for(var i = 0;i < arr.length;i++){
                    arr2 = arr2.concat(getAllchildsById(arr[i]));
                }
                for(var i = 0;i < arr2.length;i++){
                    for(var j = 0;j < data.length;j++){
                        if(arr2[i].id === data[j].id){
                            data.splice(j,1);
                            break;
                        }
                    }
                }
                $('#mask').css('display','none');
                $('#del_window').css('display','none');
                $('#bullet').text('删除成功').css('background','#86ce8b');
                showBul();
                //重新生成三个结构
                $('#content .list').html(createTreeHTML(init));
                $('#content .list h3[cus_id="'+ treeActiveId +'"]').css('color','#55addc');
                $('.item .nav').html(createBarHTML(treeActiveId));
                $('.item .file').html(createFileHTML(treeActiveId));
            })
        })
        //input输入修改
        $('.rename').on('click',function (e){
            //阻止事件冒泡
            $('.file > .checked input').on('click',function (e){
                e.stopPropagation();
            })
            $('.file > .checked input').on('mousedown',function (e){
                e.stopPropagation();
            })
            if($('.file > .checked').length ===1){
                $('.file > .checked input').css('display','block');
            }else if($('.file > .checked').length){
                $('#bullet').text('只能选择一个文件重命名').css('background','#ef8989');
                showBul();
            }else{
                $('#bullet').text('没有选中的文件，请选择后再删除').css('background','#ef8989');
                showBul();
            }
            e.stopPropagation();
        })
        $(document).on('mousedown',function (){
            
            var bl = true;
            $('.file span').each(function (index,item){
                if($(item).text()===$('.file > .checked input').val()){
                    $('#bullet').text('文件名不能重复').css('background','#ef8989');
                    showBul();
                    bl = false;
                    return;
                }
            })
            if($('.file > .checked input').val() && bl){
               var cur_id = $('.file > .checked').attr('cus_id');
               $('.file > .checked span').text($('.file > .checked input').val());
               data.forEach(function (item){
                   if(item.id == cur_id){
                    item.title = $('.file > .checked input').val();
                   }
               })
               //重新生成树状结构
                $('#content .list').html(createTreeHTML(init));
            }
            $('.file > .checked input').css('display','none').val('');
        })
        
       
    </script>
    <script src="js/tools.js"></script>
</body>
</html>